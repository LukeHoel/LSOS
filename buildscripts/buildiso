#set up colors for output
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m' # No Color

#Make build directory, if not present
cd ..
mkdir build
mkdir -p build/isodir/boot/grub

#Build Assembly bootstrapper
i686-elf-as buildfiles/boot.s -o build/boot.o

if [ $? -eq 0 ]; then
    echo -e "${GREEN}Assembly bootstrapper OK${NC}"
else
    echo -e "${RED}Assembly bootstrapper FAILED${NC}"
    exit 1
fi

#Build high level kernel (c++)
buildscripts/buildcfiles

if [ $? -ne 0 ]; then
    exit 1
fi

#Build linker
i686-elf-gcc -T buildfiles/linker.ld -o build/myos.bin -ffreestanding -O2 -nostdlib build/boot.o build/kernel.o -lgcc

if [ $? -eq 0 ]; then
    echo -e "${GREEN}Linker OK${NC}"
else
    echo -e "${RED}Linker FAILED${NC}"
    exit 1
fi

#grub multiboot stuff
cd build

if grub-file --is-x86-multiboot myos.bin; then
  echo -e "${GREEN}Multiboot confirmed${NC}"
else
  echo -e "${RED}The file is not multiboot${NC}"
  exit 1
fi

#do some iso building, dropping iso in home directory
cp myos.bin isodir/boot/myos.bin
cp ../buildfiles/grub.cfg isodir/boot/grub/grub.cfg
if [ -z "$ISODIR" ]
then
	grub-mkrescue -o ~/myos.iso isodir
else	
	grub-mkrescue -o $ISODIR/myos.iso isodir
fi
